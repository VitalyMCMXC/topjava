# Занятие 2 онлайн проекта <a href="https://github.com/JavaWebinar/topjava04">Topjava</a>

## <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFfkpsWE1uX19zV19IVHd0bTlDclc5QmhMMm4xa0Npek9DT18tdkwyLTBZdXM">Материалы урока</a>

## <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFXzByNVF3VV9zM1k">HW1: отображения списка еды в JSP</a> 
- **<a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFY3pZNDZuaFVSX2s">1_ HW1.patch</a>**
```
Изменения в UserMealsUtil:
  Сделал константу List<UserMeal> MEAL_LIST
  Убрал из имен методов Meals
  Сделал вспомогательные методы getWithExceeded и createWithExceed
  Сделал сделал merge правильно (без caloriesSumPerDate.put и через Integer::sum)
```
- <a href="http://java-course.ru/student/book1/jsp/">JSP</a>
- <a href="http://devcolibri.com/1250">JSTL для написания JSP страниц</a>
- <a href="http://javatutor.net/articles/jstl-patterns-for-developing-web-application-1">JSTL: Шаблоны для разработки веб-приложений в java</a>
- <a href="http://design-pattern.ru/patterns/mvc.html">MVC - Model View Controller</a>
- <a href="http://codehelper.ru/questions/205/new/repository-и-dao-отличия-преимущества-недостатки">Паттерны Repository и DAO</a>
- <a href="http://habrahabr.ru/post/263033/">Забудьте о DAO, используйте Repository</a>

## <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFQndBeWFOa3phRTg">HW1 (Optional): реализация CRUD</a> 
- **<a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFTUdKc2JOME14MEU">2_ HW1_ Optional.patch</a>**
- <a href="http://java-course.ru/student/book1/servlet/">Интернет-приложения на JAVA</a>
- <a href="http://stackoverflow.com/questions/246859/http-1-0-vs-1-1">HTTP 1.0 vs 1.1</a>

## <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFVDJZVTktQzRYTWc">Библиотека vs Фреймворк. Стандартные библиотеки Apache Commons, Guava</a>
-  <a href="http://commons.apache.org/">Apache Commons</a>, <a href="https://code.google.com/p/guava-libraries/wiki/GuavaExplained">Guava</a>

## <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFSFR1cDBIamIzQjA">Слои приложения. Создание каркаса приложения.</a>
- **<a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFSDJZM3I2eUxhMFU">3_ App_ layers.patch</a>**
-  <a href="https://www.genuitec.com/products/myeclipse/learning-center/spring/myeclipse-for-spring-reference-blueprints/">Архитектурные
            слои приложения в Spring</a>
-  <a href="https://ru.wikipedia.org/wiki/Инверсия_управления">Инверсия управления.</a><a href="http://image.slidesharecdn.com/springintroduction-130729220359-phpapp01/95/spring-introduction-3-638.jpg?cb=1375162442">DI/
            Service Locator</a>
-  <a href="http://habrahabr.ru/post/131993/">IoC, DI, IoC-контейнер — Просто о простом</a>   
-  <a href="http://en.wikipedia.org/wiki/Multilayered_architecture">Паттерн "Слои приложения"</a>
- Ресурсы:
  -  <a href="http://martinfowler.com/eaaCatalog/dataTransferObject.html">Паттерн DTO</a>. <a href="http://stackoverflow.com/questions/1612334/difference-between-dto-vo-pojo-javabeans">Value Object и Data Transfer Object</a>

##  <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFWXA1b0pnMGlvU0U">Обзор  Spring Framework. Spring Context.</a>
- **<a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFQUdfVTkyNWpMMk0">4_ Add_ spring_ context_ and_ main.patch</a>**
- **<a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFRDVOQ3dsQ202eFk">5_ Add_ dependency_ injection.patch</a>**
- **<a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFeThhWFozOU1DYmM">6_ Add_ annotation_ processing.patch</a>**

-  <a href="http://en.wikipedia.org/wiki/Spring_Framework">Spring Framework</a>
-  <a href="http://spring.io/projects">Проекты Spring</a>.
-  <a href=http://docs.spring.io/spring/docs/current/spring-framework-reference/html/overview.html>Обзор Spring Framework</a>
-  Ресурсы:
   -  <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html">Introduction to the Spring IoC container
       and beans</a>
   -  <a href="http://it.vaclav.kiev.ua/2010/12/25/spring-framework-for-begginers-part-7/">Constructor против Setter Injection </a>
   -  <a href="http://stackoverflow.com/questions/6827752/whats-the-difference-between-component-repository-service-annotations-in">Difference
       between @Component, @Repository & @Service annotations in Spring</a>
   -  <a href="http://www.mkyong.com/spring/spring-auto-scanning-components/">Spring Auto Scanning Components</a>
   -  <a href="https://spring.io/guides">Getting Started</a>
   -  <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/">Spring Framework Reference Documentation</a>
   -  <a href="https://github.com/spring-projects">Spring на GitHub</a>

##  <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFN2N6LS1PVE96SW8">Пояснения к HW2. Обработка Autowired</a>
  
## Домашнее задание HW02

    - Переименовать MockUserRepositoryImpl в InMemoryUserRepositoryImpl и имплементировать по аналогии с
      InMemoryUserMealRepositoryImpl (список пользователей возвращать отсортированным по имени)
  
    - Сделать реализацию слоев приложения для функциональности "еда":
      - Зарефакторить UserMealRepository/InMemoryUserMealRepositoryImpl: 
        - еда принадлежит пользователю (добавляется параметр userId)
        - список еды возвращать отсортированным по времени
        - если еда отсутствует или чужая, возвращать null/false (см. UserRepository)

      - API должна удовлетворять все потребности демо приложения и ничего лишнего (см. http://topjava.herokuapp.com)
      - после авторизации запрос попадает в контроллер, методы которого будут доступны снаружи по http
                    (id авторизованного юзера попадает (сделаем позже) в LoggedUser.id(), см. ProfileRestController).
      Пока обращаемся к контроллеру через сервлет, но он проектируется так, что дальше будем работаем с ним напрямую.
      
      - нельзя позволять модифицировать/смотреть чужую еду. Контроллеры смотрят наружу, 
        в запросе может прийти любое id. Проверять: если еда чужая или отсутствует, то бросать NotFoundException.

    - Включить классы в контекст Spring и вызвать из SpringMain методы UserMealRestController
    
Примечания:

    - LoggedUser известен только на слое web (UserMealService можно тестировать без подмены логики авторизации)
    - Пока можно НЕ добавлять поля в UserMeal (добавим позже), 
           принимаем в методах сервиса и репозитория параметр userId: id владельца еды.
    - В UserMealServiceImpl постараться сделать в каждом методе только одни запрос к UserMealRepository 
    - Не надо в названиях методов повторять названия класса, например Meal.

Optional 

    - Сделать инициализацию Spring и вызов UserMealRestController из MealServlet 
                                         (НЕ менять в pom.xml, работаем со spring-context)
    
    - Добавить в mealList.jsp и MealServlet фильтрацию еды по дате и времени (см. демо)
    
    - Добавить выбор текущего залогиненного пользователя (имитация авторизации)
      (например захардкодить 1,2 в index.html select и сделать LoggedUser.setId(userId) в UserServlet).

--------------------

## Ваши вопросы
>  какова цель деления приложения на слои?

Управляемость проекта (особенно большого) повышается на порядок:
1. Обеспечивается меньшая связываемость. Допустим если мы меняем что то в контроллере, то сервис эти изменения не задевают.
2. Облегчается тестирование (мы будем тестировать слои сервисов и контроллеров отдельно)

> DTO используются когда есть избыточность запросов которую мы уменьшаем собрав данные из разных бинов в один? 

По <a href="http://design-pattern.ru/patterns/data-transfer-object.html">ссылке</a> именно так. Я придерживаюсь подхода - если для данных, которые надо отдавать наружу entiy (хранимый бин) не подходит- делаем (Data) Transfer Object. Для них делается в проекте отдельный пакет (у нас будет to). (D)TO может быть как частью одного entiry  (набор полей) так и иерархией нескольких entity. На многих проектах (и собеседованиях) практикуют разделение на уровне maven модулей entity слоя от логики и соответствующей конвертацией ВСЕХ Entity в TO, даже если у них те же самые поля. Мы наружу будет отдавать как UserMeals, так и UserMealsWithExceeded (для таблицы).
Те UserMealsWithExceeded у нас является Transfer Object и его надо пернести в пакет to, а для UserMeals мы отдельного TO создавать не будем. Вообще сейчас разработка движется по пути уменьшения написания кода (свежий пример: <a href="http://projects.spring.io/spring-data-rest/">Spring Data REST</a>) 

---------------------
### Подсказки по HW02 (для проверки, лучше сначала сделать API самостоятельно)

- UserMealRestController должен уметь обрабатывать запросы:

    - Отдать свою еду (для отображения в таблице, формат List<UserMealWithExceed>), запрос БЕЗ параметров
    - Отдать свою еду, отфильтрованную по startDate, startTime, endDate, endTime
    - Отдать/удалить свою еду по id, параметр запроса - id еды. 
                        Если еда с этим id чужая или отсутствует - NotFoundException
    - Сохранить/обновить еду, параметр запроса - UserMeal, сконструированный из id, dateTime, description, calories
         (без User/userId). Если обновляемая еда с этим id чужая или отсутствует - NotFoundException
    - Т.к. контроллер позволяет управлять ТОЛЬКО своей едой, userId снаружи не приходит (см ProfileRestController). 

- UserMealWithExceed переносим в пакет to (transfer objects), он должен отдаваться из контроллера (тк сервлеты удалим) и слой репозиториев о нем ничего не должен знать.

- Закрывать в сервлете `springContext` грамотнее всего в `HttpServlet.destroy`
